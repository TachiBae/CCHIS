<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Child - CCHIS</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/mother-theme.css">
</head>

<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand"><i class="fas fa-heartbeat"></i> CCHIS</div>
        </div>
        <div class="sidebar-menu">
            <a href="mother-dashboard.html" class="menu-item">
                <i class="fas fa-home"></i> My Dashboard
            </a>
            <a href="my-profile.html" class="menu-item">
                <i class="fas fa-user"></i> My Profile
            </a>
            <a href="my-child.html" class="menu-item active">
                <i class="fas fa-baby"></i> My Child
            </a>
            <a href="my-appointments.html" class="menu-item">
                <i class="fas fa-calendar-alt"></i> My Appointments
            </a>
            <a href="my-records.html" class="menu-item">
                <i class="fas fa-file-medical"></i> Medical Records
            </a>
            <a href="health-resources.html" class="menu-item">
                <i class="fas fa-book-medical"></i> Health Resources
            </a>
            <a href="contact-worker.html" class="menu-item">
                <i class="fas fa-comment-medical"></i> Contact Health Worker
            </a>
            <a href="index.html" class="menu-item" style="margin-top: auto; color: var(--error-color);">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard-header"
            style="margin-bottom: 32px; padding-bottom: 0; background: transparent; display: flex; justify-content: space-between; align-items: center;">
            <h1>My Child</h1>
            <div>
                <button id="btn-edit-child" class="btn btn-primary" style="display: inline-block;">
                    <i class="fas fa-edit"></i> Edit Profile
                </button>
                <button id="btn-save-child" class="btn btn-primary" style="display: none;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button id="btn-cancel-edit" class="btn btn-secondary" style="display: none; margin-left: 8px;">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>

        <!-- Child Header -->
        <div class="card" style="text-align: center; padding-bottom: 48px;">
            <div
                style="width: 120px; height: 120px; border-radius: 50%; background: #E3F2FD; color: #1565C0; display: flex; align-items: center; justify-content: center; font-size: 48px; margin: 0 auto 16px auto; border: 4px solid white; box-shadow: var(--shadow-sm);">
                ðŸ‘¶
            </div>
            <h2 id="child-name-display" style="margin-bottom: 8px;">Baby Martinez</h2>
            <input type="text" id="child-name-edit" class="form-control"
                style="display: none; max-width: 400px; margin: 0 auto 8px auto; text-align: center; font-size: 1.5rem; font-weight: 600;" />

            <p id="child-info-display" class="text-muted" style="margin-bottom: 24px;">Born Dec 12, 2023 â€¢ 6 Weeks Old
            </p>
            <div id="child-info-edit"
                style="display: none; margin-bottom: 24px; max-width: 600px; margin-left: auto; margin-right: auto;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; text-align: left;">
                    <div class="form-group">
                        <label>Date of Birth</label>
                        <input type="date" id="child-dob-edit" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label>Sex</label>
                        <select id="child-sex-edit" class="form-control">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: center; gap: 48px;">
                <div>
                    <div class="text-muted text-small">Weight</div>
                    <div id="child-weight-display" style="font-size: 24px; font-weight: 700;">4.2 kg</div>
                    <input type="number" id="child-weight-edit" class="form-control" step="0.1"
                        style="display: none; width: 100px; margin-top: 8px; text-align: center;" />
                </div>
                <div>
                    <div class="text-muted text-small">Height</div>
                    <div id="child-height-display" style="font-size: 24px; font-weight: 700;">52 cm</div>
                    <input type="number" id="child-height-edit" class="form-control" step="0.1"
                        style="display: none; width: 100px; margin-top: 8px; text-align: center;" />
                </div>
                <div>
                    <div class="text-muted text-small">Blood Type</div>
                    <div id="child-blood-display" style="font-size: 24px; font-weight: 700;">O+</div>
                    <select id="child-blood-edit" class="form-control"
                        style="display: none; width: 100px; margin-top: 8px;">
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                        <option value="Unknown">Unknown</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="grid-container">
            <!-- Left Column: Growth & Milestones -->
            <div class="left-column">
                <!-- Growth Chart Placeholder -->
                <path d="M0,100 C20,80 50,60 100,40" stroke="#E0E0E0" stroke-width="2" fill="none" />
                <path d="M0,100 C20,70 50,50 100,20" stroke="#E0E0E0" stroke-width="2" fill="none" />
                <path d="M0,100 C20,75 50,55 100,30" stroke="#4ECDC4" stroke-width="3" fill="none" />
                </svg>
            </div>
        </div>

        <!-- Milestones -->
        <div class="card">
            <h3>Milestones Checklist</h3>
            <div id="milestones-container" style="margin-top: 16px;">
                <!-- Populated by JavaScript -->
            </div>
        </div>
        </div>

        <!-- Right Column: Vaccines -->
        <div class="right-column">
            <div class="card">
                <h3>Vaccination Schedule</h3>
                <div class="table-responsive" style="margin-top: 16px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #F8F9FA;">
                                <th
                                    style="padding: 12px; text-align: left; font-size: 13px; color: var(--text-secondary);">
                                    VACCINE</th>
                                <th
                                    style="padding: 12px; text-align: left; font-size: 13px; color: var(--text-secondary);">
                                    STATUS</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 16px 12px;">
                                    <div style="font-weight: 600;">BCG</div>
                                    <div class="text-small text-muted">At Birth</div>
                                </td>
                                <td style="padding: 16px 12px;">
                                    <span class="badge badge-safe"><i class="fas fa-check"></i> Done</span>
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 16px 12px;">
                                    <div style="font-weight: 600;">Hepatitis B</div>
                                    <div class="text-small text-muted">At Birth</div>
                                </td>
                                <td style="padding: 16px 12px;">
                                    <span class="badge badge-safe"><i class="fas fa-check"></i> Done</span>
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 16px 12px;">
                                    <div style="font-weight: 600;">Pentavalent 1</div>
                                    <div class="text-small text-muted">6 Weeks</div>
                                </td>
                                <td style="padding: 16px 12px;">
                                    <span class="badge badge-warning">Due Soon</span>
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 16px 12px;">
                                    <div style="font-weight: 600;">OPV 1</div>
                                    <div class="text-small text-muted">6 Weeks</div>
                                </td>
                                <td style="padding: 16px 12px;">
                                    <span class="badge badge-warning">Due Soon</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/data.js"></script>
    <script src="js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Edit Mode Functionality
            let isEditMode = false;
            let currentChild = null;

            document.getElementById('btn-edit-child').addEventListener('click', function () {
                isEditMode = true;
                toggleEditMode(true);
            });

            document.getElementById('btn-cancel-edit').addEventListener('click', function () {
                isEditMode = false;
                toggleEditMode(false);
                // Reload original data
                loadChildData();
            });

            document.getElementById('btn-save-child').addEventListener('click', function () {
                if (!currentChild) return;

                // Get updated values
                currentChild.name = document.getElementById('child-name-edit').value;
                currentChild.birthDate = document.getElementById('child-dob-edit').value;
                currentChild.sex = document.getElementById('child-sex-edit').value;
                currentChild.currentWeight = parseFloat(document.getElementById('child-weight-edit').value) || currentChild.birthWeight;
                currentChild.currentHeight = parseFloat(document.getElementById('child-height-edit').value) || currentChild.birthLength;
                currentChild.bloodType = document.getElementById('child-blood-edit').value;

                // Update in mockData
                const childIndex = window.mockData.children.findIndex(c => c.id === currentChild.id);
                if (childIndex !== -1) {
                    window.mockData.children[childIndex] = currentChild;
                    localStorage.setItem('cchisData', JSON.stringify(window.mockData));

                    alert('Child profile updated successfully!');
                    isEditMode = false;
                    toggleEditMode(false);
                    loadChildData();
                }
            });
            isEditMode = false;
            toggleEditMode(false);
            // Reload original data
            loadChildData();
        });

        document.getElementById('btn-save-child').addEventListener('click', function () {
            if (!currentChild) return;

            // Get updated values
            currentChild.name = document.getElementById('child-name-edit').value;
            currentChild.birthDate = document.getElementById('child-dob-edit').value;
            currentChild.sex = document.getElementById('child-sex-edit').value;
            currentChild.currentWeight = parseFloat(document.getElementById('child-weight-edit').value) || currentChild.birthWeight;
            currentChild.currentHeight = parseFloat(document.getElementById('child-height-edit').value) || currentChild.birthLength;
            currentChild.bloodType = document.getElementById('child-blood-edit').value;

            // Update in mockData
            const childIndex = window.mockData.children.findIndex(c => c.id === currentChild.id);
            if (childIndex !== -1) {
                window.mockData.children[childIndex] = currentChild;
                localStorage.setItem('cchisData', JSON.stringify(window.mockData));

                alert('Child profile updated successfully!');
                isEditMode = false;
                toggleEditMode(false);
                loadChildData();
            }
        });

        function toggleEditMode(edit) {
            // Toggle buttons
            document.getElementById('btn-edit-child').style.display = edit ? 'none' : 'inline-block';
            document.getElementById('btn-save-child').style.display = edit ? 'inline-block' : 'none';
            document.getElementById('btn-cancel-edit').style.display = edit ? 'inline-block' : 'none';

            // Toggle name field
            document.getElementById('child-name-display').style.display = edit ? 'none' : 'block';
            document.getElementById('child-name-edit').style.display = edit ? 'block' : 'none';

            // Toggle info fields
            document.getElementById('child-info-display').style.display = edit ? 'none' : 'block';
            document.getElementById('child-info-edit').style.display = edit ? 'block' : 'none';

            // Toggle stat fields
            document.getElementById('child-weight-display').style.display = edit ? 'none' : 'block';
            document.getElementById('child-weight-edit').style.display = edit ? 'inline-block' : 'none';

            document.getElementById('child-height-display').style.display = edit ? 'none' : 'block';
            document.getElementById('child-height-edit').style.display = edit ? 'inline-block' : 'none';

            document.getElementById('child-blood-display').style.display = edit ? 'none' : 'block';
            document.getElementById('child-blood-edit').style.display = edit ? 'inline-block' : 'none';
        }

        function loadChildData() {
            const userId = localStorage.getItem('userId');
            if (!userId) return;

            // Find mother data
            const mother = window.mockData.mothers.find(m => m.id === userId);
            if (!mother) return;

            // Find child data
            let child = null;
            if (mother.childId) {
                child = window.mockData.children.find(c => c.id === mother.childId);
            } else {
                child = window.mockData.children.find(c => c.motherId === userId);
            }

            if (!child) return;

            currentChild = child;

            // Update Header (Display mode)
            document.getElementById('child-name-display').textContent = child.name;
            document.getElementById('child-name-edit').value = child.name;

            const dobDate = new Date(child.birthDate);
            const ageInWeeks = Math.floor((new Date() - dobDate) / (1000 * 60 * 60 * 24 * 7));
            document.getElementById('child-info-display').textContent = `Born ${dobDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} \u2022 ${ageInWeeks} Weeks Old`;

            // Update edit fields
            document.getElementById('child-dob-edit').value = child.birthDate;
            document.getElementById('child-sex-edit').value = child.sex;

            // Update Stats (Display mode)
            const weight = child.currentWeight || child.birthWeight || 'N/A';
            const height = child.currentHeight || child.birthLength || 'N/A';
            const bloodType = child.bloodType || 'Unknown';

            document.getElementById('child-weight-display').textContent = `${weight} kg`;
            document.getElementById('child-weight-edit').value = weight !== 'N/A' ? weight : '';

            document.getElementById('child-height-display').textContent = `${height} cm`;
            document.getElementById('child-height-edit').value = height !== 'N/A' ? height : '';

            document.getElementById('child-blood-display').textContent = bloodType;
            document.getElementById('child-blood-edit').value = bloodType;

            // Update Immunizations
            const childImmunizations = window.mockData.immunizations.filter(i => i.childId === child.id);

            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const vaccineNameDiv = row.querySelector('td:first-child div[style*="font-weight: 600"]');
                if (!vaccineNameDiv) return;

                const vaccineName = vaccineNameDiv.textContent.trim();
                const record = childImmunizations.find(i => i.vaccine === vaccineName || (vaccineName.includes(i.vaccine) && i.vaccine.length > 3));

                const statusCell = row.querySelector('td:last-child');
                if (record) {
                    statusCell.innerHTML = `<span class="badge badge-safe"><i class="fas fa-check"></i> Done</span>`;
                } else {
                    if (statusCell.textContent.includes('Done')) {
                        statusCell.innerHTML = `<span class="badge badge-warning">Pending</span>`;
                    }
                }
            });

            // Render Milestones
            renderMilestones(child.id);
        }

        function renderMilestones(childId) {
            const container = document.getElementById('milestones-container');
            if (!container) {
                console.error('Milestones container not found');
                return;
            }

            // Ensure milestones data exists
            if (!window.mockData || !window.mockData.milestones || window.mockData.milestones.length === 0) {
                console.error('Milestones data not available');
                container.innerHTML = '<p class="text-muted">Loading milestones...</p>';
                return;
            }

            const achievedMilestones = window.mockData.childMilestones ?
                window.mockData.childMilestones.filter(cm => cm.childId === childId) : [];

            console.log('Rendering milestones for child:', childId, 'Total milestones:', window.mockData.milestones.length);

            container.innerHTML = window.mockData.milestones.map((milestone, index) => {
                const isAchieved = achievedMilestones.some(cm => cm.milestoneId === milestone.id);
                const isLast = index === window.mockData.milestones.length - 1;

                return `
                    <div style="display: flex; align-items: center; padding: 12px 0; ${!isLast ? 'border-bottom: 1px solid var(--border-color);' : ''}">
                        <input type="checkbox" 
                            ${isAchieved ? 'checked' : ''}
                            data-milestone-id="${milestone.id}"
                            data-child-id="${childId}"
                            onchange="handleMilestoneChange(this)"
                            style="width: 20px; height: 20px; margin-right: 16px; accent-color: var(--success-color);">
                        <span style="${isAchieved ? 'text-decoration: line-through; color: var(--text-secondary);' : ''}">${milestone.name}</span>
                        <span class="text-muted text-small" style="margin-left: auto;">${milestone.ageMonths} months</span>
                    </div>
                `;
            }).join('');
        }

        // Global function to handle milestone checkbox changes
        window.handleMilestoneChange = function (checkbox) {
            const milestoneId = checkbox.dataset.milestoneId;
            const childId = checkbox.dataset.childId;
            const isChecked = checkbox.checked;

            if (isChecked) {
                // Add milestone achievement
                const existingIndex = window.mockData.childMilestones.findIndex(
                    cm => cm.childId === childId && cm.milestoneId === milestoneId
                );

                if (existingIndex === -1) {
                    window.mockData.childMilestones.push({
                        childId: childId,
                        milestoneId: milestoneId,
                        achievedDate: new Date().toISOString().split('T')[0]
                    });
                }
            } else {
                // Remove milestone achievement
                const index = window.mockData.childMilestones.findIndex(
                    cm => cm.childId === childId && cm.milestoneId === milestoneId
                );

                if (index !== -1) {
                    window.mockData.childMilestones.splice(index, 1);
                }
            }

            // Save to localStorage
            localStorage.setItem('cchisData', JSON.stringify(window.mockData));

            // Re-render to update styling
            renderMilestones(childId);
        };

        // Load data on page load
        loadChildData();
    </script>
</body>

</html>